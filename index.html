<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quản Lý Hệ Thống</title>
    <style>
        body {
            font-family: 'Roboto', sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f0f2f5;
        }
        .navbar {
            background-color: #1e90ff;
            display: none;
            justify-content: center;
            padding: 10px 0;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        .navbar a {
            color: white;
            text-decoration: none;
            padding: 10px 20px;
            margin: 0 5px;
            border-radius: 5px;
            transition: background-color 0.3s;
        }
        .navbar a:hover {
            background-color: #0056b3;
        }
        .container {
            padding: 20px;
            text-align: center;
        }
        .login-form {
            max-width: 350px;
            margin: 50px auto;
            padding: 30px;
            background: linear-gradient(145deg, #ffffff, #e6e6e6);
            box-shadow: 10px 10px 20px #cfcfcf, -10px -10px 20px #ffffff;
            border-radius: 15px;
        }
        .login-form h2 {
            margin-bottom: 20px;
            font-size: 24px;
            color: #333;
        }
        .login-form input[type="text"],
        .login-form input[type="password"] {
            width: 100%;
            padding: 12px;
            margin: 15px 0;
            border: none;
            border-radius: 25px;
            box-shadow: inset 3px 3px 5px #c8c8c8, inset -3px -3px 5px #ffffff;
        }
        .login-form input[type="submit"] {
            width: 100%;
            padding: 12px;
            background-color: #1e90ff;
            color: white;
            border: none;
            cursor: pointer;
            border-radius: 25px;
            font-size: 16px;
            transition: background-color 0.3s;
        }
        .login-form input[type="submit"]:hover {
            background-color: #0056b3;
        }
        .page {
            display: none;
            padding: 20px;
        }
        .device-blocks, table {
            width: 100%;
            margin-top: 30px;
            border-collapse: collapse;
        }
        .device-blocks {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 30px;
        }
        .device-block {
            width: 220px;
            padding: 20px;
            background: linear-gradient(145deg, #ffffff, #e6e6e6);
            box-shadow: 10px 10px 20px #cfcfcf, -10px -10px 20px #ffffff;
            text-align: center;
            border-radius: 15px;
        }
        .device-block img {
            width: 70px;
            height: 70px;
            margin: 20px 0;
        }
        .device-block span {
            display: block;
            font-size: 16px;
            font-weight: bold;
            color: #333;
            margin-top: 10px;
        }
        table th, table td {
            padding: 12px 15px;
            text-align: center;
            border: 1px solid #ddd;
        }
        table thead {
            background-color: #1e90ff;
            color: white;
        }
        table tbody tr:nth-child(even) {
            background-color: #f9f9f9;
        }
    </style>
    <script>
        function handleLogin(event) {
            event.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            if (username === 'Admin' && password === '123') {
                document.querySelector('.login-form').style.display = 'none';
                document.querySelector('.navbar').style.display = 'flex';
                document.getElementById('device-page').style.display = 'block';
            } else {
                alert('Tên đăng nhập hoặc mật khẩu không đúng!');
            }
        }
        function showPage(pageId) {
            document.querySelectorAll('.page').forEach(page => page.style.display = 'none');
            document.getElementById(pageId).style.display = 'block';
        }
    </script>
</head>
<body>
    <div class="navbar">
        <a href="javascript:void(0)" onclick="showPage('device-page')">Thiết Bị</a>
        <a href="javascript:void(0)" onclick="showPage('history-page')">Lịch Sử Ra Vào</a>
        <a href="javascript:void(0)" onclick="showPage('employee-page')">Quản Lý Nhân Sự</a>
        <a href="javascript:void(0)" onclick="showPage('notification-page')">Thông Báo</a>
	<a href="javascript:void(0)" onclick="showPage('tonkho')">Tồn kho</a>
        <a href="javascript:void(0)" onclick="handleLogout()">Đăng Xuất</a>

    </div>

    <div class="container">
        <div class="login-form">
            <h2>Đăng nhập</h2>
            <form onsubmit="handleLogin(event)">
                <input type="text" id="username" name="username" placeholder="Tên đăng nhập" required>
                <input type="password" id="password" name="password" placeholder="Mật khẩu" required>
                <input type="submit" value="Đăng nhập">
            </form>
        </div>
    </div>

    <div id="device-page" class="page">
	    abcde
        <h2>Trạng Thái Thiết Bị</h2>
        <div class="device-blocks">
            <!-- Hàng trên -->
            <div class="device-block">
                <span>Trạng Thái Cửa</span>
                <img id="logoCua"src="open.jpg" alt="Cửa">
            </div>
            <div class="device-block">
                <span>Trạng Thái Chuông</span>
                <img id="logoChuong" src="alarm1.png" alt="Chuông">
            </div>
            <div class="device-block">
                <span>Trạng Thái Đèn</span>
                <img id="logoDen"src="lamp1.png" alt="Đèn">
            </div>
        </div>
        <div class="device-blocks">
            <!-- Hàng dưới -->
            <div class="device-block">
                <span>Nhiệt Độ</span>
                <span id="GTND">123 độ C</span>
            </div>
            <div class="device-block">
                <span>Độ Ẩm</span>
                <span id="GTDA">123 %</span>
            </div>
            <div class="device-block">
                <span>Khoảng Cách</span>
                <span id="GTKC">123 Cm</span>
            </div>
        </div>
    </div>

    <div id="history-page" class="page">
        <h2>Lịch Sử Ra Vào</h2>
        <table>
            <thead>
                <tr>
                    <th>STT</th>
                    <th>Thời Gian</th>
                    <th>Nhân Sự</th>
                    <th>Chức Vụ</th>
                    <th>Trạng Thái Cửa</th>
                </tr>
            </thead>
            <tbody id="history-table-body">
                <!-- Dữ liệu sẽ được thêm vào đây -->
            </tbody>
        </table>
        <div class="pagination">
            <button id="prevPage" onclick="changePage(-1)">← Trang Trước</button>
            <span id="pageNumber">Trang 1</span>
            <button id="nextPage" onclick="changePage(1)">Trang Sau →</button>
        </div>
    </div>
    
    <style>
        .pagination {
            text-align: center;
            margin-top: 10px;
        }
        .pagination button {
            padding: 10px 15px;
            margin: 5px;
            background-color: #1e90ff;
            color: white;
            border: none;
            cursor: pointer;
            border-radius: 5px;
        }
        .pagination button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
    </style>
    
    
    <div id="employee-page" class="page" style="display: none;">
        <h2>Quản Lý Nhân Sự</h2>
        <table>
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Tên</th>
                    <th>Chức vụ</th>
                    <th>Số điện thoại</th>
                    <th>Giới tính</th>
                    <th>Quyền</th>
                    <th>Hành Động</th>
                </tr>
            </thead>
            <tbody id="employee-table-body">
                <!-- Dữ liệu từ Firebase sẽ được thêm vào đây -->
            </tbody>
        </table>
        
    </div>
    <div id="notification-page" class="page">
        <h2>Thông Báo</h2>
        <table>
            <thead>
                <tr>
                    <th>STT</th>
                    <th>Thời Gian</th>
                    <th>Nội Dung</th>
                </tr>
            </thead>
            <tbody id="notification-table-body">
                <!-- Dữ liệu sẽ được thêm vào đây -->
            </tbody>
        </table>
    </div>

<div id="tonkho" class="page">
        <h2>Tồn Kho</h2>
        <table>
            <thead>
                <tr>
                    <th>STT</th>
       		    <th>Tên/Loại</th>
                    <th>Vị trí</th>
		    <th>Số lượng</th>
                </tr>
            </thead>
            <tbody id="slton-table-body">
                <!-- Dữ liệu sẽ được thêm vào đây -->
            </tbody>
        </table>
    </div>

    
    <script>
        function handleLogout() {
            if (confirm("Bạn có chắc chắn muốn đăng xuất không?")) {
                // Ẩn tất cả các trang
                document.querySelectorAll('.page').forEach(page => page.style.display = 'none');
                // Ẩn navbar
                document.querySelector('.navbar').style.display = 'none';
                // Hiển thị lại form đăng nhập
                document.querySelector('.login-form').style.display = 'block';
            }
        }
    </script>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        var NDRef = firebase.database().ref('ND');  // ✅ Định nghĩa đúng tham chiếu dữ liệu

        NDRef.on('value', function (snapshot) {
            var NDValue = snapshot.val();  // ✅ Lấy giá trị từ Firebase
            var NDElement = document.getElementById('GTND');

            if (NDElement) {  // ✅ Kiểm tra phần tử tồn tại trước khi cập nhật
                NDElement.textContent = NDValue + ' độ C';  // ✅ Sửa lỗi biến
            } else {
                console.error("Phần tử #GTND không tồn tại!");
            }
        }, function (error) {
            console.error("Lỗi khi đọc dữ liệu từ Firebase:", error);
        });
    });
    document.addEventListener("DOMContentLoaded", function () {
        var DARef = firebase.database().ref('DA');  // ✅ Định nghĩa đúng tham chiếu dữ liệu

        DARef.on('value', function (snapshot) {
            var DAValue = snapshot.val();  // ✅ Lấy giá trị từ Firebase
            var DAElement = document.getElementById('GTDA');

            if (DAElement) {  // ✅ Kiểm tra phần tử tồn tại trước khi cập nhật
                DAElement.textContent = DAValue + ' %';  // ✅ Sửa lỗi biến
            } else {
                console.error("Phần tử #GTND không tồn tại!");
            }
        }, function (error) {
            console.error("Lỗi khi đọc dữ liệu từ Firebase:", error);
        });
    });
    document.addEventListener("DOMContentLoaded", function () {
        var KCRef = firebase.database().ref('KC');  // ✅ Định nghĩa đúng tham chiếu dữ liệu

        KCRef.on('value', function (snapshot) {
            var KCValue = snapshot.val();  // ✅ Lấy giá trị từ Firebase
            var KCElement = document.getElementById('GTKC');

            if (KCElement) {  // ✅ Kiểm tra phần tử tồn tại trước khi cập nhật
                KCElement.textContent = KCValue + ' Cm';  // ✅ Sửa lỗi biến
            } else {
                console.error("Phần tử #GTND không tồn tại!");
            }
        }, function (error) {
            console.error("Lỗi khi đọc dữ liệu từ Firebase:", error);
        });
    });
    document.addEventListener("DOMContentLoaded", function () {
            var CuaRef = firebase.database().ref('Cua');

            CuaRef.on('value', function (snapshot) {
                var CuaValue = snapshot.val();
                var logoCua = document.getElementById('logoCua');
                var logoDen = document.getElementById('logoDen');

                if (CuaValue === 0) {
                    logoCua.src = "close.jpg"; 
                    logoDen.src = "lamp0.png"; 
                    
                } else if (CuaValue === 1) {
                    logoCua.src = "open.jpg"; 
                    logoDen.src = "lamp1.png"; 
                    
                }
            });
        });
        document.addEventListener("DOMContentLoaded", function () {
            var ChuongRef = firebase.database().ref('Chuong');

            ChuongRef.on('value', function (snapshot) {
                var ChuongValue = snapshot.val();
                var logoChuong = document.getElementById('logoChuong');

                if (ChuongValue === 0) {
                    logoChuong.src = "alarm2.png"; 
                    
                } else if (ChuongValue === 1) {
                    logoChuong.src = "alarm1.png"; 
                    
                }
            });
        }); 
        
    
</script>

<!-- Popup Chỉnh Sửa Nhân Sự -->
<div id="editUserPopup" class="popup">
    <div class="popup-content">
        <h2>Chỉnh Sửa Nhân Sự</h2>
        <label>ID Thẻ:</label> <input type="text" id="editIDThe" disabled><br>
        <label>Tên:</label> <input type="text" id="editTen"><br>
        <label>Chức Vụ:</label> <input type="text" id="editChucVu"><br>
        <label>Số Điện Thoại:</label> <input type="text" id="editSDT"><br>
        <label>Giới Tính:</label> <input type="text" id="editGioiTinh"><br>
        <label>Quyền:</label> 
        <select id="editQuyen">
            <option value="1">Cho phép</option>
            <option value="0">Không cho phép</option>
        </select><br>
        <button onclick="saveUserData()">Lưu</button>
        <button onclick="closePopup()">Hủy</button>
    </div>
</div>


<style>
    /* CSS cho popup */
    .popup {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        justify-content: center;
        align-items: center;
    }
    .popup-content {
        background: white;
        padding: 20px;
        border-radius: 10px;
        text-align: center;
        width: 300px;
    }
    .popup-content input {
        width: 100%;
        padding: 5px;
        margin: 5px 0;
    }
    .popup-content button {
        margin: 10px;
        padding: 8px;
        cursor: pointer;
    }
</style>


<script>
    document.addEventListener("DOMContentLoaded", function () {
        var usersRef = firebase.database().ref("User");

        usersRef.on("value", function (snapshot) { // ✅ Sử dụng `on` thay vì `once`
            var usersData = snapshot.val() || {}; 
            console.log("🔥 Dữ liệu đã xử lý:", usersData);

            var tbody = document.getElementById("employee-table-body");
            tbody.innerHTML = ""; // Xóa nội dung cũ trước khi cập nhật

            for (var i = 1; i <= 5; i++) {
                var user = usersData[i] || {}; 
                var quyenText = (user.Quyen === 1) ? "Cho phép" : "Không cho phép";
                var row = document.createElement("tr");
                row.innerHTML = `
                    <td>${i}</td>
                    <td>${user.Ten || "Chưa cập nhật"}</td>
                    <td>${user.ChucVu || "Chưa cập nhật"}</td>
                    <td>${user.SDT || "Chưa cập nhật"}</td>
                    <td>${user.GioiTinh || "Chưa cập nhật"}</td>
                    <td>${quyenText}</td> <!-- ✅ Hiển thị số nguyên -->
                    <td>
                        <button onclick="openEditPopup('${i}', '${user.Ten || ""}', '${user.ChucVu || ""}', '${user.SDT || ""}', '${user.GioiTinh || ""}', '${user.Quyen || 0}')">
                            Cài Đặt
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            }
        }, function (error) {
            console.error("❌ Lỗi khi đọc dữ liệu từ Firebase:", error);
        });
    });

    function openEditPopup(userId, ten, chucVu, sdt, gioiTinh, quyen) {
        document.getElementById("editIDThe").value = userId;
        document.getElementById("editTen").value = ten;
        document.getElementById("editChucVu").value = chucVu;
        document.getElementById("editSDT").value = sdt;
        document.getElementById("editGioiTinh").value = gioiTinh;
        var quyenSelect = document.getElementById("editQuyen");
        quyenSelect.value = (quyen === "1" || quyen === 1) ? "1" : "0";
        document.getElementById("editUserPopup").style.display = "flex";
    }

    function closePopup() {
        document.getElementById("editUserPopup").style.display = "none";
    }

    function saveUserData() {
        var userId = document.getElementById("editIDThe").value;
        var newName = document.getElementById("editTen").value.trim();
        var newChucVu = document.getElementById("editChucVu").value.trim();
        var newSDT = document.getElementById("editSDT").value.trim();
        var newGioiTinh = document.getElementById("editGioiTinh").value.trim();
        var newQuyen = parseInt(document.getElementById("editQuyen").value.trim(), 10);

        if (!newName) {
            alert("Tên không được để trống!");
            return;
        }

        // ✅ Kiểm tra nếu quyền không phải số hoặc bị NaN, đặt về 0
        if (isNaN(newQuyen)) {
            alert("Quyền phải là số nguyên!");
            newQuyen = 0;
        }

        firebase.database().ref("User/" + userId).update({
            Ten: newName,
            ChucVu: newChucVu || "Chưa cập nhật",
            SDT: newSDT || "Chưa cập nhật",
            GioiTinh: newGioiTinh || "Chưa cập nhật",
            Quyen: newQuyen // ✅ Gửi lên Firebase dưới dạng số nguyên
        }).then(() => {
            closePopup();
            var quyenText = (newQuyen === 1) ? "Cho phép" : "Không cho phép";
            // ✅ Cập nhật ngay trên giao diện mà không cần reload
            document.querySelector(`#employee-table-body tr:nth-child(${userId}) td:nth-child(2)`).textContent = newName;
            document.querySelector(`#employee-table-body tr:nth-child(${userId}) td:nth-child(3)`).textContent = newChucVu || "Chưa cập nhật";
            document.querySelector(`#employee-table-body tr:nth-child(${userId}) td:nth-child(4)`).textContent = newSDT || "Chưa cập nhật";
            document.querySelector(`#employee-table-body tr:nth-child(${userId}) td:nth-child(5)`).textContent = newGioiTinh || "Chưa cập nhật";
            document.querySelector(`#employee-table-body tr:nth-child(${userId}) td:nth-child(6)`).textContent = quyenText;
            
        }).catch(error => {
            console.error("Lỗi khi cập nhật dữ liệu:", error);
            alert("Cập nhật thất bại!");
        });
    }
</script>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        var usersRef = firebase.database().ref("User");
        var cuaRef = firebase.database().ref("Cua"); // Trạng thái cửa

        usersRef.on("value", function (snapshot) {
            var usersData = snapshot.val() || {}; 
            console.log("🔥 Kiểm tra dữ liệu user:", usersData);

            Object.keys(usersData).forEach(function (userId) {
                var userRef = firebase.database().ref("User/" + userId + "/QuetThe");

                userRef.once("value", function (quetTheSnapshot) { // ✅ Chỉ kích hoạt một lần
                    var quetTheValue = quetTheSnapshot.val();

                    if (quetTheValue === 1) { // ✅ Khi phát hiện quẹt thẻ
                        var now = new Date();
                        var thoiGian = now.toLocaleString("vi-VN", { hour12: false });

                        // Lấy thông tin nhân sự
                        var nhanSu = usersData[userId].Ten || "Không rõ";
                        var chucVu = usersData[userId].ChucVu || "Không rõ";

                        // ✅ Ngăn ghi trùng bằng cách đặt lại `QuetThe = 0` ngay lập tức
                        userRef.set(0).then(() => {
                            console.log("✅ Đã đặt lại QuetThe = 0 cho User", userId);

                            // Lấy trạng thái cửa
                            cuaRef.once("value", function (cuaSnapshot) {
                                var trangThaiCua = (cuaSnapshot.val() === 1) ? "Mở" : "Đóng";

                                // Lưu vào Firebase
                                var historyRef = firebase.database().ref("History").push();
                                historyRef.set({
                                    ThoiGian: thoiGian,
                                    NhanSu: nhanSu,
                                    ChucVu: chucVu,
                                    TrangThaiCua: (trangThaiCua === "Mở") ? "Đóng" : "Mở"
                                }).then(() => {
                                    console.log("✅ Đã lưu lịch sử quẹt thẻ:", { ThoiGian: thoiGian, NhanSu: nhanSu, ChucVu: chucVu, TrangThaiCua: trangThaiCua });
                                }).catch(error => {
                                    console.error("❌ Lỗi khi lưu lịch sử:", error);
                                });
                            });
                        }).catch(error => {
                            console.error("❌ Lỗi khi đặt lại QuetThe:", error);
                        });
                    }
                });
            });
        });
    });
</script>

<script>
    var historyData = []; // Lưu trữ toàn bộ lịch sử
    var currentPage = 1; // Trang hiện tại
    var itemsPerPage = 10; // Số lượng bản ghi mỗi trang

    // Hàm chuyển đổi chuỗi ThoiGian sang đối tượng Date
    function parseThoiGian(dateStr) {
      // Định dạng ban đầu: "HH:mm:ss D/M/YYYY"
      let parts = dateStr.split(" ");
      if (parts.length !== 2) return new Date(dateStr); // fallback nếu không đúng định dạng
      let timePart = parts[0]; // "18:29:28"
      let datePart = parts[1]; // "7/2/2025"
      let dateParts = datePart.split("/");
      if(dateParts.length !== 3) return new Date(dateStr);
      // Giả sử dateParts theo thứ tự: ngày/tháng/năm
      let day = dateParts[0];
      let month = dateParts[1];
      let year = dateParts[2];
      // Tạo chuỗi theo định dạng "MM/DD/YYYY HH:mm:ss" mà Date constructor có thể nhận
      let formattedDateStr = `${month}/${day}/${year} ${timePart}`;
      return new Date(formattedDateStr);
    }

    document.addEventListener("DOMContentLoaded", function () {
        var historyRef = firebase.database().ref("History");

        // Lắng nghe dữ liệu thay đổi trong Firebase
        historyRef.on("value", function (snapshot) {
            var data = snapshot.val() || {}; // Nếu không có dữ liệu, tạo object rỗng
            console.log("🔥 Dữ liệu lịch sử:", data);

            // Chuyển dữ liệu từ Object sang Array và sắp xếp theo thời gian mới nhất trước
            let rawData = Object.values(data).sort((a, b) => {
                return parseThoiGian(b.ThoiGian) - parseThoiGian(a.ThoiGian);
            });

            // Lọc bỏ dữ liệu trùng lặp dựa trên ThoiGian
            historyData = removeDuplicates(rawData, 'ThoiGian');

            renderTable(); // Gọi hàm hiển thị dữ liệu
        }, function (error) {
            console.error("❌ Lỗi khi đọc lịch sử từ Firebase:", error);
        });
    });

    // Hàm lọc dữ liệu trùng lặp theo một key nhất định
    function removeDuplicates(dataArray, key) {
        let uniqueData = [];
        let seenKeys = new Set();

        dataArray.forEach(item => {
            if (!seenKeys.has(item[key])) {
                seenKeys.add(item[key]);
                uniqueData.push(item);
            }
        });
        return uniqueData;
    }

    function renderTable() {
        var tbody = document.getElementById("history-table-body");
        tbody.innerHTML = ""; // Xóa dữ liệu cũ trước khi cập nhật

        // Xác định phạm vi dữ liệu cần hiển thị trên trang hiện tại
        var startIndex = (currentPage - 1) * itemsPerPage;
        var endIndex = startIndex + itemsPerPage;
        var pageData = historyData.slice(startIndex, endIndex);

        // Duyệt qua danh sách và hiển thị
        pageData.forEach((entry, index) => {
            var row = document.createElement("tr");
            row.innerHTML = `
                <td>${startIndex + index + 1}</td> <!-- STT -->
                <td>${entry.ThoiGian}</td>
                <td>${entry.NhanSu}</td>
                <td>${entry.ChucVu}</td>
                <td>${entry.TrangThaiCua}</td>
            `;
            tbody.appendChild(row);
        });

        // Cập nhật số trang
        document.getElementById("pageNumber").textContent = `Trang ${currentPage}`;

        // Kiểm tra xem có cần ẩn nút hay không
        document.getElementById("prevPage").disabled = (currentPage === 1);
        document.getElementById("nextPage").disabled = (endIndex >= historyData.length);
    }

    function changePage(direction) {
        currentPage += direction; // Thay đổi trang (1 = tiếp theo, -1 = trước đó)
        renderTable(); // Cập nhật hiển thị
    }
  </script>


<script>
document.addEventListener("DOMContentLoaded", function () {
  var tonRef = firebase.database().ref("TonKho");

  tonRef.on("value", function (snapshot) {
    var tonData = snapshot.val();
    console.log("Dữ liệu tồn kho đã xử lý:", tonData);

    var tbody = document.getElementById("slton-table-body");
    tbody.innerHTML = ""; // Xóa nội dung cũ

    var index = 1;
    for (var ten in tonData) {
      if (tonData.hasOwnProperty(ten)) { 
        var item = tonData[ten];
        var row = document.createElement("tr");

        row.innerHTML = `
          <td>${index}</td>
          <td>${ten}</td>
          <td>${item.ViTri}</td>
          <td>${item.Soluong}</td>
        `;
        tbody.appendChild(row);
        index++;
       } 
    }
  }, function (error) {
    console.error("Lỗi khi đọc dữ liệu từ Firebase:", error);
  });
}); 
</script> 


<script>
    // Hàm chuyển đổi chuỗi ThoiGian sang đối tượng Date
    // Định dạng ban đầu: "HH:mm:ss D/M/YYYY"
    function parseThoiGian(dateStr) {
      let parts = dateStr.split(" ");
      if (parts.length !== 2) return new Date(dateStr); // fallback nếu không đúng định dạng
      let timePart = parts[0]; // "18:32:48"
      let datePart = parts[1]; // "7/2/2025"
      let dateParts = datePart.split("/");
      if (dateParts.length !== 3) return new Date(dateStr);
      // Giả sử định dạng ban đầu là: ngày/tháng/năm
      let day = dateParts[0];
      let month = dateParts[1];
      let year = dateParts[2];
      // Tạo chuỗi theo định dạng "MM/DD/YYYY HH:mm:ss" để Date constructor nhận diện
      let formattedDateStr = `${month}/${day}/${year} ${timePart}`;
      return new Date(formattedDateStr);
    }

    var isAlertTriggered = false; // Ngăn cảnh báo trùng lặp khi `Chuong = 1`
    var lastNotification = ""; // Lưu nội dung cuối cùng để kiểm tra trùng lặp

    document.addEventListener("DOMContentLoaded", function () {
      var chuongRef = firebase.database().ref("Chuong");
      var gasRef = firebase.database().ref("GAS");
      var kcRef = firebase.database().ref("KC");
      var notificationRef = firebase.database().ref("Notifications");

      // Lắng nghe giá trị của "Chuong"
      chuongRef.on("value", function (chuongSnapshot) {
        var chuongValue = chuongSnapshot.val();

        if (chuongValue === 1 && !isAlertTriggered) { // Chỉ xử lý nếu `Chuong = 1` và chưa báo trước đó
          isAlertTriggered = true;

          var now = new Date();
          var thoiGian = now.toLocaleString("vi-VN", { hour12: false });

          gasRef.once("value", function (gasSnapshot) {
            var gasValue = gasSnapshot.val();

            kcRef.once("value", function (kcSnapshot) {
              var kcValue = kcSnapshot.val();
              var message = "";

              if (gasValue === 1) {
                message = "Phát hiện có khí gas!";
              } else if (kcValue < 30) {
                message = 'Phát hiện có người đến gần, khoảng cách: ${kcValue} cm';
              }

              // Nếu có thông báo, kiểm tra xem đã tồn tại chưa
              if (message && message !== lastNotification) {
                lastNotification = message; // Lưu lại thông báo để tránh trùng
                saveNotification(thoiGian, message);
              }
            });
          });

        } else if (chuongValue === 0) {
          // Reset khi `Chuong` về 0 để sẵn sàng cho lần báo tiếp theo
          isAlertTriggered = false;
          lastNotification = "";
        }
      });

      // Lắng nghe thông báo từ Firebase và cập nhật giao diện
      notificationRef.on("value", function (snapshot) {
        var notifications = snapshot.val() || {};
        var tbody = document.getElementById("notification-table-body");
        tbody.innerHTML = ""; // Xóa dữ liệu cũ

        // Chuyển object thành array, loại bỏ trùng lặp và sắp xếp theo thời gian mới nhất
        var uniqueNotifications = Object.values(notifications).reduce((acc, cur) => {
          if (!acc.find(n => n.NoiDung === cur.NoiDung && n.ThoiGian === cur.ThoiGian)) {
            acc.push(cur);
          }
          return acc;
        }, []).sort((a, b) => parseThoiGian(b.ThoiGian) - parseThoiGian(a.ThoiGian));

        uniqueNotifications.forEach((entry, index) => {
          var row = document.createElement("tr");
          row.innerHTML = `
            <td>${index + 1}</td>
            <td>${entry.ThoiGian}</td>
            <td>${entry.NoiDung}</td>
          `;
          tbody.appendChild(row);
        });
      });
    });

    // Hàm lưu thông báo vào Firebase
    function saveNotification(thoiGian, noiDung) {
      var newNotificationRef = firebase.database().ref("Notifications").push();
      newNotificationRef.set({
        ThoiGian: thoiGian,
        NoiDung: noiDung
      }).then(() => {
        console.log(`✅ Đã lưu thông báo: ${noiDung}`);
      }).catch(error => {
        console.error("❌ Lỗi khi lưu thông báo:", error);
      });
    }
  </script>

 


<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-analytics.js";
    import { getDatabase, ref, set, get, child } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

    // CẤU HÌNH DỰ ÁN FIREBASE CỦA BẠN
    // For Firebase JS SDK v7.20.0 and later, measurementId is optional
const firebaseConfig = {
  apiKey: "AIzaSyBpy0NgF9MCd1SX5GYbPB7p80-6m0Nv6IQ",
  authDomain: "quanlykhovukhi-791b8.firebaseapp.com",
  databaseURL: "https://quanlykhovukhi-791b8-default-rtdb.firebaseio.com",
  projectId: "quanlykhovukhi-791b8",
  storageBucket: "quanlykhovukhi-791b8.firebasestorage.app",
  messagingSenderId: "417167432247",
  appId: "1:417167432247:web:2328005d983f4555e73db2",
  measurementId: "G-6YZTPQTQME"
};

    // KHỞI TẠO APP VÀ DATABASE
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const analytics = getAnalytics(app);

</script>  

<!-- Firebase compat fix -->
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-database-compat.js"></script>
<script>
  const firebaseConfig = {
    apiKey: "AIzaSyBpy0NgF9MCd1SX5GYbPB7p80-6m0Nv6IQ",
    authDomain: "quanlykhovukhi-791b8.firebaseapp.com",
    databaseURL: "https://quanlykhovukhi-791b8-default-rtdb.firebaseio.com",
    projectId: "quanlykhovukhi-791b8",
    storageBucket: "quanlykhovukhi-791b8.firebasestorage.app",
    messagingSenderId: "417167432247",
    appId: "1:417167432247:web:2328005d983f4555e73db2",
    measurementId: "G-6YZTPQTQME"
  };

  firebase.initializeApp(firebaseConfig);
</script>

</body>
</html>
