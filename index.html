<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Qu·∫£n L√Ω H·ªá Th·ªëng</title>
    <style>
        body {
            font-family: 'Roboto', sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f0f2f5;
        }
        .navbar {
            background-color: #1e90ff;
            display: none;
            justify-content: center;
            padding: 10px 0;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        .navbar a {
            color: white;
            text-decoration: none;
            padding: 10px 20px;
            margin: 0 5px;
            border-radius: 5px;
            transition: background-color 0.3s;
        }
        .navbar a:hover {
            background-color: #0056b3;
        }
        .container {
            padding: 20px;
            text-align: center;
        }
        .login-form {
            max-width: 350px;
            margin: 50px auto;
            padding: 30px;
            background: linear-gradient(145deg, #ffffff, #e6e6e6);
            box-shadow: 10px 10px 20px #cfcfcf, -10px -10px 20px #ffffff;
            border-radius: 15px;
        }
        .login-form h2 {
            margin-bottom: 20px;
            font-size: 24px;
            color: #333;
        }
        .login-form input[type="text"],
        .login-form input[type="password"] {
            width: 100%;
            padding: 12px;
            margin: 15px 0;
            border: none;
            border-radius: 25px;
            box-shadow: inset 3px 3px 5px #c8c8c8, inset -3px -3px 5px #ffffff;
        }
        .login-form input[type="submit"] {
            width: 100%;
            padding: 12px;
            background-color: #1e90ff;
            color: white;
            border: none;
            cursor: pointer;
            border-radius: 25px;
            font-size: 16px;
            transition: background-color 0.3s;
        }
        .login-form input[type="submit"]:hover {
            background-color: #0056b3;
        }
        .page {
            display: none;
            padding: 20px;
        }
        .device-blocks, table {
            width: 100%;
            margin-top: 30px;
            border-collapse: collapse;
        }
        .device-blocks {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 30px;
        }
        .device-block {
            width: 220px;
            padding: 20px;
            background: linear-gradient(145deg, #ffffff, #e6e6e6);
            box-shadow: 10px 10px 20px #cfcfcf, -10px -10px 20px #ffffff;
            text-align: center;
            border-radius: 15px;
        }
        .device-block img {
            width: 70px;
            height: 70px;
            margin: 20px 0;
        }
        .device-block span {
            display: block;
            font-size: 16px;
            font-weight: bold;
            color: #333;
            margin-top: 10px;
        }
        table th, table td {
            padding: 12px 15px;
            text-align: center;
            border: 1px solid #ddd;
        }
        table thead {
            background-color: #1e90ff;
            color: white;
        }
        table tbody tr:nth-child(even) {
            background-color: #f9f9f9;
        }
    </style>
    <script>
        function handleLogin(event) {
            event.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            if (username === 'Admin' && password === '123') {
                document.querySelector('.login-form').style.display = 'none';
                document.querySelector('.navbar').style.display = 'flex';
                document.getElementById('device-page').style.display = 'block';
            } else {
                alert('T√™n ƒëƒÉng nh·∫≠p ho·∫∑c m·∫≠t kh·∫©u kh√¥ng ƒë√∫ng!');
            }
        }
        function showPage(pageId) {
            document.querySelectorAll('.page').forEach(page => page.style.display = 'none');
            document.getElementById(pageId).style.display = 'block';
        }
    </script>
</head>
<body>
    <div class="navbar">
        <a href="javascript:void(0)" onclick="showPage('device-page')">Thi·∫øt B·ªã</a>
        <a href="javascript:void(0)" onclick="showPage('history-page')">L·ªãch S·ª≠ Ra V√†o</a>
        <a href="javascript:void(0)" onclick="showPage('employee-page')">Qu·∫£n L√Ω Nh√¢n S·ª±</a>
        <a href="javascript:void(0)" onclick="showPage('notification-page')">Th√¥ng B√°o</a>
	<a href="javascript:void(0)" onclick="showPage('tonkho')">T·ªìn kho</a>
        <a href="javascript:void(0)" onclick="handleLogout()">ƒêƒÉng Xu·∫•t</a>

    </div>

    <div class="container">
        <div class="login-form">
            <h2>ƒêƒÉng nh·∫≠p</h2>
            <form onsubmit="handleLogin(event)">
                <input type="text" id="username" name="username" placeholder="T√™n ƒëƒÉng nh·∫≠p" required>
                <input type="password" id="password" name="password" placeholder="M·∫≠t kh·∫©u" required>
                <input type="submit" value="ƒêƒÉng nh·∫≠p">
            </form>
        </div>
    </div>

    <div id="device-page" class="page">
	    abcde
        <h2>Tr·∫°ng Th√°i Thi·∫øt B·ªã</h2>
        <div class="device-blocks">
            <!-- H√†ng tr√™n -->
            <div class="device-block">
                <span>Tr·∫°ng Th√°i C·ª≠a</span>
                <img id="logoCua"src="open.jpg" alt="C·ª≠a">
            </div>
            <div class="device-block">
                <span>Tr·∫°ng Th√°i Chu√¥ng</span>
                <img id="logoChuong" src="alarm1.png" alt="Chu√¥ng">
            </div>
            <div class="device-block">
                <span>Tr·∫°ng Th√°i ƒê√®n</span>
                <img id="logoDen"src="lamp1.png" alt="ƒê√®n">
            </div>
        </div>
        <div class="device-blocks">
            <!-- H√†ng d∆∞·ªõi -->
            <div class="device-block">
                <span>Nhi·ªát ƒê·ªô</span>
                <span id="GTND">123 ƒë·ªô C</span>
            </div>
            <div class="device-block">
                <span>ƒê·ªô ·∫®m</span>
                <span id="GTDA">123 %</span>
            </div>
            <div class="device-block">
                <span>Kho·∫£ng C√°ch</span>
                <span id="GTKC">123 Cm</span>
            </div>
        </div>
    </div>

    <div id="history-page" class="page">
        <h2>L·ªãch S·ª≠ Ra V√†o</h2>
        <table>
            <thead>
                <tr>
                    <th>STT</th>
                    <th>Th·ªùi Gian</th>
                    <th>Nh√¢n S·ª±</th>
                    <th>Ch·ª©c V·ª•</th>
                    <th>Tr·∫°ng Th√°i C·ª≠a</th>
                </tr>
            </thead>
            <tbody id="history-table-body">
                <!-- D·ªØ li·ªáu s·∫Ω ƒë∆∞·ª£c th√™m v√†o ƒë√¢y -->
            </tbody>
        </table>
        <div class="pagination">
            <button id="prevPage" onclick="changePage(-1)">‚Üê Trang Tr∆∞·ªõc</button>
            <span id="pageNumber">Trang 1</span>
            <button id="nextPage" onclick="changePage(1)">Trang Sau ‚Üí</button>
        </div>
    </div>
    
    <style>
        .pagination {
            text-align: center;
            margin-top: 10px;
        }
        .pagination button {
            padding: 10px 15px;
            margin: 5px;
            background-color: #1e90ff;
            color: white;
            border: none;
            cursor: pointer;
            border-radius: 5px;
        }
        .pagination button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
    </style>
    
    
    <div id="employee-page" class="page" style="display: none;">
        <h2>Qu·∫£n L√Ω Nh√¢n S·ª±</h2>
        <table>
            <thead>
                <tr>
                    <th>ID</th>
                    <th>T√™n</th>
                    <th>Ch·ª©c v·ª•</th>
                    <th>S·ªë ƒëi·ªán tho·∫°i</th>
                    <th>Gi·ªõi t√≠nh</th>
                    <th>Quy·ªÅn</th>
                    <th>H√†nh ƒê·ªông</th>
                </tr>
            </thead>
            <tbody id="employee-table-body">
                <!-- D·ªØ li·ªáu t·ª´ Firebase s·∫Ω ƒë∆∞·ª£c th√™m v√†o ƒë√¢y -->
            </tbody>
        </table>
        
    </div>
    <div id="notification-page" class="page">
        <h2>Th√¥ng B√°o</h2>
        <table>
            <thead>
                <tr>
                    <th>STT</th>
                    <th>Th·ªùi Gian</th>
                    <th>N·ªôi Dung</th>
                </tr>
            </thead>
            <tbody id="notification-table-body">
                <!-- D·ªØ li·ªáu s·∫Ω ƒë∆∞·ª£c th√™m v√†o ƒë√¢y -->
            </tbody>
        </table>
    </div>

<div id="tonkho" class="page">
        <h2>T·ªìn Kho</h2>
        <table>
            <thead>
                <tr>
                    <th>STT</th>
       		    <th>T√™n/Lo·∫°i</th>
                    <th>V·ªã tr√≠</th>
		    <th>S·ªë l∆∞·ª£ng</th>
                </tr>
            </thead>
            <tbody id="slton-table-body">
                <!-- D·ªØ li·ªáu s·∫Ω ƒë∆∞·ª£c th√™m v√†o ƒë√¢y -->
            </tbody>
        </table>
    </div>

    
    <script>
        function handleLogout() {
            if (confirm("B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën ƒëƒÉng xu·∫•t kh√¥ng?")) {
                // ·∫®n t·∫•t c·∫£ c√°c trang
                document.querySelectorAll('.page').forEach(page => page.style.display = 'none');
                // ·∫®n navbar
                document.querySelector('.navbar').style.display = 'none';
                // Hi·ªÉn th·ªã l·∫°i form ƒëƒÉng nh·∫≠p
                document.querySelector('.login-form').style.display = 'block';
            }
        }
    </script>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        var NDRef = firebase.database().ref('ND');  // ‚úÖ ƒê·ªãnh nghƒ©a ƒë√∫ng tham chi·∫øu d·ªØ li·ªáu

        NDRef.on('value', function (snapshot) {
            var NDValue = snapshot.val();  // ‚úÖ L·∫•y gi√° tr·ªã t·ª´ Firebase
            var NDElement = document.getElementById('GTND');

            if (NDElement) {  // ‚úÖ Ki·ªÉm tra ph·∫ßn t·ª≠ t·ªìn t·∫°i tr∆∞·ªõc khi c·∫≠p nh·∫≠t
                NDElement.textContent = NDValue + ' ƒë·ªô C';  // ‚úÖ S·ª≠a l·ªói bi·∫øn
            } else {
                console.error("Ph·∫ßn t·ª≠ #GTND kh√¥ng t·ªìn t·∫°i!");
            }
        }, function (error) {
            console.error("L·ªói khi ƒë·ªçc d·ªØ li·ªáu t·ª´ Firebase:", error);
        });
    });
    document.addEventListener("DOMContentLoaded", function () {
        var DARef = firebase.database().ref('DA');  // ‚úÖ ƒê·ªãnh nghƒ©a ƒë√∫ng tham chi·∫øu d·ªØ li·ªáu

        DARef.on('value', function (snapshot) {
            var DAValue = snapshot.val();  // ‚úÖ L·∫•y gi√° tr·ªã t·ª´ Firebase
            var DAElement = document.getElementById('GTDA');

            if (DAElement) {  // ‚úÖ Ki·ªÉm tra ph·∫ßn t·ª≠ t·ªìn t·∫°i tr∆∞·ªõc khi c·∫≠p nh·∫≠t
                DAElement.textContent = DAValue + ' %';  // ‚úÖ S·ª≠a l·ªói bi·∫øn
            } else {
                console.error("Ph·∫ßn t·ª≠ #GTND kh√¥ng t·ªìn t·∫°i!");
            }
        }, function (error) {
            console.error("L·ªói khi ƒë·ªçc d·ªØ li·ªáu t·ª´ Firebase:", error);
        });
    });
    document.addEventListener("DOMContentLoaded", function () {
        var KCRef = firebase.database().ref('KC');  // ‚úÖ ƒê·ªãnh nghƒ©a ƒë√∫ng tham chi·∫øu d·ªØ li·ªáu

        KCRef.on('value', function (snapshot) {
            var KCValue = snapshot.val();  // ‚úÖ L·∫•y gi√° tr·ªã t·ª´ Firebase
            var KCElement = document.getElementById('GTKC');

            if (KCElement) {  // ‚úÖ Ki·ªÉm tra ph·∫ßn t·ª≠ t·ªìn t·∫°i tr∆∞·ªõc khi c·∫≠p nh·∫≠t
                KCElement.textContent = KCValue + ' Cm';  // ‚úÖ S·ª≠a l·ªói bi·∫øn
            } else {
                console.error("Ph·∫ßn t·ª≠ #GTND kh√¥ng t·ªìn t·∫°i!");
            }
        }, function (error) {
            console.error("L·ªói khi ƒë·ªçc d·ªØ li·ªáu t·ª´ Firebase:", error);
        });
    });
    document.addEventListener("DOMContentLoaded", function () {
            var CuaRef = firebase.database().ref('Cua');

            CuaRef.on('value', function (snapshot) {
                var CuaValue = snapshot.val();
                var logoCua = document.getElementById('logoCua');
                var logoDen = document.getElementById('logoDen');

                if (CuaValue === 0) {
                    logoCua.src = "close.jpg"; 
                    logoDen.src = "lamp0.png"; 
                    
                } else if (CuaValue === 1) {
                    logoCua.src = "open.jpg"; 
                    logoDen.src = "lamp1.png"; 
                    
                }
            });
        });
        document.addEventListener("DOMContentLoaded", function () {
            var ChuongRef = firebase.database().ref('Chuong');

            ChuongRef.on('value', function (snapshot) {
                var ChuongValue = snapshot.val();
                var logoChuong = document.getElementById('logoChuong');

                if (ChuongValue === 0) {
                    logoChuong.src = "alarm2.png"; 
                    
                } else if (ChuongValue === 1) {
                    logoChuong.src = "alarm1.png"; 
                    
                }
            });
        }); 
        
    
</script>

<!-- Popup Ch·ªânh S·ª≠a Nh√¢n S·ª± -->
<div id="editUserPopup" class="popup">
    <div class="popup-content">
        <h2>Ch·ªânh S·ª≠a Nh√¢n S·ª±</h2>
        <label>ID Th·∫ª:</label> <input type="text" id="editIDThe" disabled><br>
        <label>T√™n:</label> <input type="text" id="editTen"><br>
        <label>Ch·ª©c V·ª•:</label> <input type="text" id="editChucVu"><br>
        <label>S·ªë ƒêi·ªán Tho·∫°i:</label> <input type="text" id="editSDT"><br>
        <label>Gi·ªõi T√≠nh:</label> <input type="text" id="editGioiTinh"><br>
        <label>Quy·ªÅn:</label> 
        <select id="editQuyen">
            <option value="1">Cho ph√©p</option>
            <option value="0">Kh√¥ng cho ph√©p</option>
        </select><br>
        <button onclick="saveUserData()">L∆∞u</button>
        <button onclick="closePopup()">H·ªßy</button>
    </div>
</div>


<style>
    /* CSS cho popup */
    .popup {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        justify-content: center;
        align-items: center;
    }
    .popup-content {
        background: white;
        padding: 20px;
        border-radius: 10px;
        text-align: center;
        width: 300px;
    }
    .popup-content input {
        width: 100%;
        padding: 5px;
        margin: 5px 0;
    }
    .popup-content button {
        margin: 10px;
        padding: 8px;
        cursor: pointer;
    }
</style>


<script>
    document.addEventListener("DOMContentLoaded", function () {
        var usersRef = firebase.database().ref("User");

        usersRef.on("value", function (snapshot) { // ‚úÖ S·ª≠ d·ª•ng `on` thay v√¨ `once`
            var usersData = snapshot.val() || {}; 
            console.log("üî• D·ªØ li·ªáu ƒë√£ x·ª≠ l√Ω:", usersData);

            var tbody = document.getElementById("employee-table-body");
            tbody.innerHTML = ""; // X√≥a n·ªôi dung c≈© tr∆∞·ªõc khi c·∫≠p nh·∫≠t

            for (var i = 1; i <= 5; i++) {
                var user = usersData[i] || {}; 
                var quyenText = (user.Quyen === 1) ? "Cho ph√©p" : "Kh√¥ng cho ph√©p";
                var row = document.createElement("tr");
                row.innerHTML = `
                    <td>${i}</td>
                    <td>${user.Ten || "Ch∆∞a c·∫≠p nh·∫≠t"}</td>
                    <td>${user.ChucVu || "Ch∆∞a c·∫≠p nh·∫≠t"}</td>
                    <td>${user.SDT || "Ch∆∞a c·∫≠p nh·∫≠t"}</td>
                    <td>${user.GioiTinh || "Ch∆∞a c·∫≠p nh·∫≠t"}</td>
                    <td>${quyenText}</td> <!-- ‚úÖ Hi·ªÉn th·ªã s·ªë nguy√™n -->
                    <td>
                        <button onclick="openEditPopup('${i}', '${user.Ten || ""}', '${user.ChucVu || ""}', '${user.SDT || ""}', '${user.GioiTinh || ""}', '${user.Quyen || 0}')">
                            C√†i ƒê·∫∑t
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            }
        }, function (error) {
            console.error("‚ùå L·ªói khi ƒë·ªçc d·ªØ li·ªáu t·ª´ Firebase:", error);
        });
    });

    function openEditPopup(userId, ten, chucVu, sdt, gioiTinh, quyen) {
        document.getElementById("editIDThe").value = userId;
        document.getElementById("editTen").value = ten;
        document.getElementById("editChucVu").value = chucVu;
        document.getElementById("editSDT").value = sdt;
        document.getElementById("editGioiTinh").value = gioiTinh;
        var quyenSelect = document.getElementById("editQuyen");
        quyenSelect.value = (quyen === "1" || quyen === 1) ? "1" : "0";
        document.getElementById("editUserPopup").style.display = "flex";
    }

    function closePopup() {
        document.getElementById("editUserPopup").style.display = "none";
    }

    function saveUserData() {
        var userId = document.getElementById("editIDThe").value;
        var newName = document.getElementById("editTen").value.trim();
        var newChucVu = document.getElementById("editChucVu").value.trim();
        var newSDT = document.getElementById("editSDT").value.trim();
        var newGioiTinh = document.getElementById("editGioiTinh").value.trim();
        var newQuyen = parseInt(document.getElementById("editQuyen").value.trim(), 10);

        if (!newName) {
            alert("T√™n kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng!");
            return;
        }

        // ‚úÖ Ki·ªÉm tra n·∫øu quy·ªÅn kh√¥ng ph·∫£i s·ªë ho·∫∑c b·ªã NaN, ƒë·∫∑t v·ªÅ 0
        if (isNaN(newQuyen)) {
            alert("Quy·ªÅn ph·∫£i l√† s·ªë nguy√™n!");
            newQuyen = 0;
        }

        firebase.database().ref("User/" + userId).update({
            Ten: newName,
            ChucVu: newChucVu || "Ch∆∞a c·∫≠p nh·∫≠t",
            SDT: newSDT || "Ch∆∞a c·∫≠p nh·∫≠t",
            GioiTinh: newGioiTinh || "Ch∆∞a c·∫≠p nh·∫≠t",
            Quyen: newQuyen // ‚úÖ G·ª≠i l√™n Firebase d∆∞·ªõi d·∫°ng s·ªë nguy√™n
        }).then(() => {
            closePopup();
            var quyenText = (newQuyen === 1) ? "Cho ph√©p" : "Kh√¥ng cho ph√©p";
            // ‚úÖ C·∫≠p nh·∫≠t ngay tr√™n giao di·ªán m√† kh√¥ng c·∫ßn reload
            document.querySelector(`#employee-table-body tr:nth-child(${userId}) td:nth-child(2)`).textContent = newName;
            document.querySelector(`#employee-table-body tr:nth-child(${userId}) td:nth-child(3)`).textContent = newChucVu || "Ch∆∞a c·∫≠p nh·∫≠t";
            document.querySelector(`#employee-table-body tr:nth-child(${userId}) td:nth-child(4)`).textContent = newSDT || "Ch∆∞a c·∫≠p nh·∫≠t";
            document.querySelector(`#employee-table-body tr:nth-child(${userId}) td:nth-child(5)`).textContent = newGioiTinh || "Ch∆∞a c·∫≠p nh·∫≠t";
            document.querySelector(`#employee-table-body tr:nth-child(${userId}) td:nth-child(6)`).textContent = quyenText;
            
        }).catch(error => {
            console.error("L·ªói khi c·∫≠p nh·∫≠t d·ªØ li·ªáu:", error);
            alert("C·∫≠p nh·∫≠t th·∫•t b·∫°i!");
        });
    }
</script>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        var usersRef = firebase.database().ref("User");
        var cuaRef = firebase.database().ref("Cua"); // Tr·∫°ng th√°i c·ª≠a

        usersRef.on("value", function (snapshot) {
            var usersData = snapshot.val() || {}; 
            console.log("üî• Ki·ªÉm tra d·ªØ li·ªáu user:", usersData);

            Object.keys(usersData).forEach(function (userId) {
                var userRef = firebase.database().ref("User/" + userId + "/QuetThe");

                userRef.once("value", function (quetTheSnapshot) { // ‚úÖ Ch·ªâ k√≠ch ho·∫°t m·ªôt l·∫ßn
                    var quetTheValue = quetTheSnapshot.val();

                    if (quetTheValue === 1) { // ‚úÖ Khi ph√°t hi·ªán qu·∫πt th·∫ª
                        var now = new Date();
                        var thoiGian = now.toLocaleString("vi-VN", { hour12: false });

                        // L·∫•y th√¥ng tin nh√¢n s·ª±
                        var nhanSu = usersData[userId].Ten || "Kh√¥ng r√µ";
                        var chucVu = usersData[userId].ChucVu || "Kh√¥ng r√µ";

                        // ‚úÖ NgƒÉn ghi tr√πng b·∫±ng c√°ch ƒë·∫∑t l·∫°i `QuetThe = 0` ngay l·∫≠p t·ª©c
                        userRef.set(0).then(() => {
                            console.log("‚úÖ ƒê√£ ƒë·∫∑t l·∫°i QuetThe = 0 cho User", userId);

                            // L·∫•y tr·∫°ng th√°i c·ª≠a
                            cuaRef.once("value", function (cuaSnapshot) {
                                var trangThaiCua = (cuaSnapshot.val() === 1) ? "M·ªü" : "ƒê√≥ng";

                                // L∆∞u v√†o Firebase
                                var historyRef = firebase.database().ref("History").push();
                                historyRef.set({
                                    ThoiGian: thoiGian,
                                    NhanSu: nhanSu,
                                    ChucVu: chucVu,
                                    TrangThaiCua: (trangThaiCua === "M·ªü") ? "ƒê√≥ng" : "M·ªü"
                                }).then(() => {
                                    console.log("‚úÖ ƒê√£ l∆∞u l·ªãch s·ª≠ qu·∫πt th·∫ª:", { ThoiGian: thoiGian, NhanSu: nhanSu, ChucVu: chucVu, TrangThaiCua: trangThaiCua });
                                }).catch(error => {
                                    console.error("‚ùå L·ªói khi l∆∞u l·ªãch s·ª≠:", error);
                                });
                            });
                        }).catch(error => {
                            console.error("‚ùå L·ªói khi ƒë·∫∑t l·∫°i QuetThe:", error);
                        });
                    }
                });
            });
        });
    });
</script>

<script>
    var historyData = []; // L∆∞u tr·ªØ to√†n b·ªô l·ªãch s·ª≠
    var currentPage = 1; // Trang hi·ªán t·∫°i
    var itemsPerPage = 10; // S·ªë l∆∞·ª£ng b·∫£n ghi m·ªói trang

    // H√†m chuy·ªÉn ƒë·ªïi chu·ªói ThoiGian sang ƒë·ªëi t∆∞·ª£ng Date
    function parseThoiGian(dateStr) {
      // ƒê·ªãnh d·∫°ng ban ƒë·∫ßu: "HH:mm:ss D/M/YYYY"
      let parts = dateStr.split(" ");
      if (parts.length !== 2) return new Date(dateStr); // fallback n·∫øu kh√¥ng ƒë√∫ng ƒë·ªãnh d·∫°ng
      let timePart = parts[0]; // "18:29:28"
      let datePart = parts[1]; // "7/2/2025"
      let dateParts = datePart.split("/");
      if(dateParts.length !== 3) return new Date(dateStr);
      // Gi·∫£ s·ª≠ dateParts theo th·ª© t·ª±: ng√†y/th√°ng/nƒÉm
      let day = dateParts[0];
      let month = dateParts[1];
      let year = dateParts[2];
      // T·∫°o chu·ªói theo ƒë·ªãnh d·∫°ng "MM/DD/YYYY HH:mm:ss" m√† Date constructor c√≥ th·ªÉ nh·∫≠n
      let formattedDateStr = `${month}/${day}/${year} ${timePart}`;
      return new Date(formattedDateStr);
    }

    document.addEventListener("DOMContentLoaded", function () {
        var historyRef = firebase.database().ref("History");

        // L·∫Øng nghe d·ªØ li·ªáu thay ƒë·ªïi trong Firebase
        historyRef.on("value", function (snapshot) {
            var data = snapshot.val() || {}; // N·∫øu kh√¥ng c√≥ d·ªØ li·ªáu, t·∫°o object r·ªóng
            console.log("üî• D·ªØ li·ªáu l·ªãch s·ª≠:", data);

            // Chuy·ªÉn d·ªØ li·ªáu t·ª´ Object sang Array v√† s·∫Øp x·∫øp theo th·ªùi gian m·ªõi nh·∫•t tr∆∞·ªõc
            let rawData = Object.values(data).sort((a, b) => {
                return parseThoiGian(b.ThoiGian) - parseThoiGian(a.ThoiGian);
            });

            // L·ªçc b·ªè d·ªØ li·ªáu tr√πng l·∫∑p d·ª±a tr√™n ThoiGian
            historyData = removeDuplicates(rawData, 'ThoiGian');

            renderTable(); // G·ªçi h√†m hi·ªÉn th·ªã d·ªØ li·ªáu
        }, function (error) {
            console.error("‚ùå L·ªói khi ƒë·ªçc l·ªãch s·ª≠ t·ª´ Firebase:", error);
        });
    });

    // H√†m l·ªçc d·ªØ li·ªáu tr√πng l·∫∑p theo m·ªôt key nh·∫•t ƒë·ªãnh
    function removeDuplicates(dataArray, key) {
        let uniqueData = [];
        let seenKeys = new Set();

        dataArray.forEach(item => {
            if (!seenKeys.has(item[key])) {
                seenKeys.add(item[key]);
                uniqueData.push(item);
            }
        });
        return uniqueData;
    }

    function renderTable() {
        var tbody = document.getElementById("history-table-body");
        tbody.innerHTML = ""; // X√≥a d·ªØ li·ªáu c≈© tr∆∞·ªõc khi c·∫≠p nh·∫≠t

        // X√°c ƒë·ªãnh ph·∫°m vi d·ªØ li·ªáu c·∫ßn hi·ªÉn th·ªã tr√™n trang hi·ªán t·∫°i
        var startIndex = (currentPage - 1) * itemsPerPage;
        var endIndex = startIndex + itemsPerPage;
        var pageData = historyData.slice(startIndex, endIndex);

        // Duy·ªát qua danh s√°ch v√† hi·ªÉn th·ªã
        pageData.forEach((entry, index) => {
            var row = document.createElement("tr");
            row.innerHTML = `
                <td>${startIndex + index + 1}</td> <!-- STT -->
                <td>${entry.ThoiGian}</td>
                <td>${entry.NhanSu}</td>
                <td>${entry.ChucVu}</td>
                <td>${entry.TrangThaiCua}</td>
            `;
            tbody.appendChild(row);
        });

        // C·∫≠p nh·∫≠t s·ªë trang
        document.getElementById("pageNumber").textContent = `Trang ${currentPage}`;

        // Ki·ªÉm tra xem c√≥ c·∫ßn ·∫©n n√∫t hay kh√¥ng
        document.getElementById("prevPage").disabled = (currentPage === 1);
        document.getElementById("nextPage").disabled = (endIndex >= historyData.length);
    }

    function changePage(direction) {
        currentPage += direction; // Thay ƒë·ªïi trang (1 = ti·∫øp theo, -1 = tr∆∞·ªõc ƒë√≥)
        renderTable(); // C·∫≠p nh·∫≠t hi·ªÉn th·ªã
    }
  </script>


<script>
document.addEventListener("DOMContentLoaded", function () {
  var tonRef = firebase.database().ref("TonKho");

  tonRef.on("value", function (snapshot) {
    var tonData = snapshot.val();
    console.log("D·ªØ li·ªáu t·ªìn kho ƒë√£ x·ª≠ l√Ω:", tonData);

    var tbody = document.getElementById("slton-table-body");
    tbody.innerHTML = ""; // X√≥a n·ªôi dung c≈©

    var index = 1;
    for (var ten in tonData) {
      if (tonData.hasOwnProperty(ten)) { 
        var item = tonData[ten];
        var row = document.createElement("tr");

        row.innerHTML = `
          <td>${index}</td>
          <td>${ten}</td>
          <td>${item.ViTri}</td>
          <td>${item.Soluong}</td>
        `;
        tbody.appendChild(row);
        index++;
       } 
    }
  }, function (error) {
    console.error("L·ªói khi ƒë·ªçc d·ªØ li·ªáu t·ª´ Firebase:", error);
  });
}); 
</script> 


<script>
    // H√†m chuy·ªÉn ƒë·ªïi chu·ªói ThoiGian sang ƒë·ªëi t∆∞·ª£ng Date
    // ƒê·ªãnh d·∫°ng ban ƒë·∫ßu: "HH:mm:ss D/M/YYYY"
    function parseThoiGian(dateStr) {
      let parts = dateStr.split(" ");
      if (parts.length !== 2) return new Date(dateStr); // fallback n·∫øu kh√¥ng ƒë√∫ng ƒë·ªãnh d·∫°ng
      let timePart = parts[0]; // "18:32:48"
      let datePart = parts[1]; // "7/2/2025"
      let dateParts = datePart.split("/");
      if (dateParts.length !== 3) return new Date(dateStr);
      // Gi·∫£ s·ª≠ ƒë·ªãnh d·∫°ng ban ƒë·∫ßu l√†: ng√†y/th√°ng/nƒÉm
      let day = dateParts[0];
      let month = dateParts[1];
      let year = dateParts[2];
      // T·∫°o chu·ªói theo ƒë·ªãnh d·∫°ng "MM/DD/YYYY HH:mm:ss" ƒë·ªÉ Date constructor nh·∫≠n di·ªán
      let formattedDateStr = `${month}/${day}/${year} ${timePart}`;
      return new Date(formattedDateStr);
    }

    var isAlertTriggered = false; // NgƒÉn c·∫£nh b√°o tr√πng l·∫∑p khi `Chuong = 1`
    var lastNotification = ""; // L∆∞u n·ªôi dung cu·ªëi c√πng ƒë·ªÉ ki·ªÉm tra tr√πng l·∫∑p

    document.addEventListener("DOMContentLoaded", function () {
      var chuongRef = firebase.database().ref("Chuong");
      var gasRef = firebase.database().ref("GAS");
      var kcRef = firebase.database().ref("KC");
      var notificationRef = firebase.database().ref("Notifications");

      // L·∫Øng nghe gi√° tr·ªã c·ªßa "Chuong"
      chuongRef.on("value", function (chuongSnapshot) {
        var chuongValue = chuongSnapshot.val();

        if (chuongValue === 1 && !isAlertTriggered) { // Ch·ªâ x·ª≠ l√Ω n·∫øu `Chuong = 1` v√† ch∆∞a b√°o tr∆∞·ªõc ƒë√≥
          isAlertTriggered = true;

          var now = new Date();
          var thoiGian = now.toLocaleString("vi-VN", { hour12: false });

          gasRef.once("value", function (gasSnapshot) {
            var gasValue = gasSnapshot.val();

            kcRef.once("value", function (kcSnapshot) {
              var kcValue = kcSnapshot.val();
              var message = "";

              if (gasValue === 1) {
                message = "Ph√°t hi·ªán c√≥ kh√≠ gas!";
              } else if (kcValue < 30) {
                message = 'Ph√°t hi·ªán c√≥ ng∆∞·ªùi ƒë·∫øn g·∫ßn, kho·∫£ng c√°ch: ${kcValue} cm';
              }

              // N·∫øu c√≥ th√¥ng b√°o, ki·ªÉm tra xem ƒë√£ t·ªìn t·∫°i ch∆∞a
              if (message && message !== lastNotification) {
                lastNotification = message; // L∆∞u l·∫°i th√¥ng b√°o ƒë·ªÉ tr√°nh tr√πng
                saveNotification(thoiGian, message);
              }
            });
          });

        } else if (chuongValue === 0) {
          // Reset khi `Chuong` v·ªÅ 0 ƒë·ªÉ s·∫µn s√†ng cho l·∫ßn b√°o ti·∫øp theo
          isAlertTriggered = false;
          lastNotification = "";
        }
      });

      // L·∫Øng nghe th√¥ng b√°o t·ª´ Firebase v√† c·∫≠p nh·∫≠t giao di·ªán
      notificationRef.on("value", function (snapshot) {
        var notifications = snapshot.val() || {};
        var tbody = document.getElementById("notification-table-body");
        tbody.innerHTML = ""; // X√≥a d·ªØ li·ªáu c≈©

        // Chuy·ªÉn object th√†nh array, lo·∫°i b·ªè tr√πng l·∫∑p v√† s·∫Øp x·∫øp theo th·ªùi gian m·ªõi nh·∫•t
        var uniqueNotifications = Object.values(notifications).reduce((acc, cur) => {
          if (!acc.find(n => n.NoiDung === cur.NoiDung && n.ThoiGian === cur.ThoiGian)) {
            acc.push(cur);
          }
          return acc;
        }, []).sort((a, b) => parseThoiGian(b.ThoiGian) - parseThoiGian(a.ThoiGian));

        uniqueNotifications.forEach((entry, index) => {
          var row = document.createElement("tr");
          row.innerHTML = `
            <td>${index + 1}</td>
            <td>${entry.ThoiGian}</td>
            <td>${entry.NoiDung}</td>
          `;
          tbody.appendChild(row);
        });
      });
    });

    // H√†m l∆∞u th√¥ng b√°o v√†o Firebase
    function saveNotification(thoiGian, noiDung) {
      var newNotificationRef = firebase.database().ref("Notifications").push();
      newNotificationRef.set({
        ThoiGian: thoiGian,
        NoiDung: noiDung
      }).then(() => {
        console.log(`‚úÖ ƒê√£ l∆∞u th√¥ng b√°o: ${noiDung}`);
      }).catch(error => {
        console.error("‚ùå L·ªói khi l∆∞u th√¥ng b√°o:", error);
      });
    }
  </script>

 


<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-analytics.js";
    import { getDatabase, ref, set, get, child } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

    // C·∫§U H√åNH D·ª∞ √ÅN FIREBASE C·ª¶A B·∫†N
    // For Firebase JS SDK v7.20.0 and later, measurementId is optional
const firebaseConfig = {
  apiKey: "AIzaSyBpy0NgF9MCd1SX5GYbPB7p80-6m0Nv6IQ",
  authDomain: "quanlykhovukhi-791b8.firebaseapp.com",
  databaseURL: "https://quanlykhovukhi-791b8-default-rtdb.firebaseio.com",
  projectId: "quanlykhovukhi-791b8",
  storageBucket: "quanlykhovukhi-791b8.firebasestorage.app",
  messagingSenderId: "417167432247",
  appId: "1:417167432247:web:2328005d983f4555e73db2",
  measurementId: "G-6YZTPQTQME"
};

    // KH·ªûI T·∫†O APP V√Ä DATABASE
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const analytics = getAnalytics(app);

</script>  

<!-- Firebase compat fix -->
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-database-compat.js"></script>
<script>
  const firebaseConfig = {
    apiKey: "AIzaSyBpy0NgF9MCd1SX5GYbPB7p80-6m0Nv6IQ",
    authDomain: "quanlykhovukhi-791b8.firebaseapp.com",
    databaseURL: "https://quanlykhovukhi-791b8-default-rtdb.firebaseio.com",
    projectId: "quanlykhovukhi-791b8",
    storageBucket: "quanlykhovukhi-791b8.firebasestorage.app",
    messagingSenderId: "417167432247",
    appId: "1:417167432247:web:2328005d983f4555e73db2",
    measurementId: "G-6YZTPQTQME"
  };

  firebase.initializeApp(firebaseConfig);
</script>

</body>
</html>
